

CONSTANTS:
    {--
     -  Turnouts
     -}
    NUM_TURNOUTS = 4

    TURNOUT_DIRECTION_PRIMARY = OFF
    TURNOUT_DIRECTION_SECONDARY = ON

    TURNOUT_TYPE_TORTOISE = 1
    TURNOUT_TYPE_ATLAS = 2

SMARTCABS:
    SmartCab1
    SmartCab2
    SmartCab3

{--
 -  Tortoise, Board 1
 -
 -  YardMaster 1 (16 control)
 -  Sentry 1 (16 sensor)
 -}
CONTROLS:
    Turnout_05_Control 'YardMaster 1, Port 01
    Turnout_08_Control 'YardMaster 1, Port 02
    Turnout_14_Control 'YardMaster 1, Port 03
    Turnout_A1_Control 'YardMaster 1, Port 04
    Turnout_12_Control 'YardMaster 1, Port 05
    Turnout_19_Control 'YardMaster 1, Port 06
    Turnout_20_Control 'YardMaster 1, Port 07
    Turnout_06_Control 'YardMaster 1, Port 08
    Turnout_07_Control 'YardMaster 1, Port 09
    Turnout_A2_Control 'YardMaster 1, Port 10
    Turnout_A3_Control 'YardMaster 1, Port 11
    Turnout_A4_Control 'YardMaster 1, Port 12
    Turnout_A5_Control 'YardMaster 1, Port 13
    Turnout_A6_Control 'YardMaster 1, Port 14
    Turnout_A7_Control 'YardMaster 1, Port 15
    Turnout_A8_Control 'YardMaster 1, Port 16
SENSORS:
    Turnout_05_Sensor 'Sentry 1, Port 01
    Turnout_08_Sensor 'Sentry 1, Port 02
    Turnout_14_Sensor 'Sentry 1, Port 03
    Turnout_A1_Sensor 'Sentry 1, Port 04
    Turnout_12_Sensor 'Sentry 1, Port 05
    Turnout_19_Sensor 'Sentry 1, Port 06
    Turnout_20_Sensor 'Sentry 1, Port 07
    Turnout_06_Sensor 'Sentry 1, Port 08
    Turnout_07_Sensor 'Sentry 1, Port 09
    Turnout_A2_Sensor 'Sentry 1, Port 10
    Turnout_A3_Sensor 'Sentry 1, Port 11
    Turnout_A4_Sensor 'Sentry 1, Port 12
    Turnout_A5_Sensor 'Sentry 1, Port 13
    Turnout_A6_Sensor 'Sentry 1, Port 14
    Turnout_A7_Sensor 'Sentry 1, Port 15
    Turnout_A8_Sensor 'Sentry 1, Port 16

{--
 -  Block Control, Board 1

 -  TrainBrain 1 (4 control, 4 sensor)
 -  TrainBrain 2 (4 control, 4 sensor)
 -  Dash-8 1 (8 control)
 -}
CONTROLS:
    Block_08_Control_1 'TrainBrain 1, Port 1
    Block_01_Control_1 'TrainBrain 1, Port 2
    Block_05_Control_1 'TrainBrain 1, Port 3
    Block_09_Control_1 'TrainBrain 1, Port 4
SENSORS:
    Block_08_East_Sensor 'TrainBrain 1, Port 1
    Block_08_West_Sensor 'TrainBrain 1, Port 2
    Block_01_East_Sensor 'TrainBrain 1, Port 3
    Block_01_West_Sensor 'TrainBrain 1, Port 4
CONTROLS:
    Block_08_Control_2 'TrainBrain 2, Port 1
    Block_01_Control_2 'TrainBrain 2, Port 2
    Block_05_Control_2 'TrainBrain 2, Port 3
    Block_09_Control_2 'TrainBrain 2, Port 4
SENSORS:
    Block_05_East_Sensor 'TrainBrain 2, Port 1
    Block_05_West_Sensor 'TrainBrain 2, Port 2
    Block_09_East_Sensor 'TrainBrain 2, Port 3
    Block_09_West_Sensor 'TrainBrain 2, Port 4
CONTROLS:
    Block_08_Control_3 'Dash-8 1, port 1
    Block_01_Control_3 'Dash-8 1, port 2
    Block_05_Control_3 'Dash-8 1, port 3
    Block_09_Control_3 'Dash-8 1, port 4
    Block_B1_Control_3 'Dash-8 1, port 5
    Block_B2_Control_3 'Dash-8 1, port 6
    Block_B3_Control_3 'Dash-8 1, port 7
    Block_B4_Control_3 'Dash-8 1, port 8

{--
 -  Atlas Control, Board 1

 -  Switchman 1 (16 control)
 -}
CONTROLS:
    Turnout_19_Primary_Control 'Switchman 1, port 1
    Turnout_18_Secondary_Control 'Switchman 1, port 2
    Turnout_20_Primary_Control 'Switchman 1, port 3
    Turnout_20_Secondary_Control 'Switchman 1, port 4
    Turnout_C1_Control 'Switchman 1, port 5
    Turnout_C2_Control 'Switchman 1, port 6
    Turnout_C3_Control 'Switchman 1, port 7
    Turnout_C4_Control 'Switchman 1, port 8
    Turnout_C5_Control 'Switchman 1, port 9
    Turnout_C6_Control 'Switchman 1, port 10
    Turnout_C7_Control 'Switchman 1, port 11
    Turnout_C8_Control 'Switchman 1, port 12
    Turnout_C9_Control 'Switchman 1, port 13
    Turnout_CA_Control 'Switchman 1, port 14
    Turnout_CB_Control 'Switchman 1, port 15
    Turnout_CC_Control 'Switchman 1, port 16

{--
 -  Block Control, Board 2

 -  TrainBrain 1 (4 control, 4 sensor)
 -  TrainBrain 2 (4 control, 4 sensor)
 -  Dash-8 1 (8 control)
 -}
CONTROLS:
    Block_07_Control_1 'TrainBrain 1, Port 1
    Block_11_Control_1 'TrainBrain 1, Port 2
    Block_04_Control_1 'TrainBrain 1, Port 3
    Block_12_Control_1 'TrainBrain 1, Port 4
SENSORS:
    Block_07_East_Sensor 'TrainBrain 1, Port 1
    Block_07_West_Sensor 'TrainBrain 1, Port 2
    Block_11_East_Sensor 'TrainBrain 1, Port 3
    Block_11_West_Sensor 'TrainBrain 1, Port 4
CONTROLS:
    Block_07_Control_2 'TrainBrain 2, Port 1
    Block_11_Control_2 'TrainBrain 2, Port 2
    Block_04_Control_2 'TrainBrain 2, Port 3
    Block_12_Control_2 'TrainBrain 2, Port 4
SENSORS:
    Block_04_East_Sensor 'TrainBrain 2, Port 1
    Block_04_West_Sensor 'TrainBrain 2, Port 2
    Block_12_East_Sensor 'TrainBrain 2, Port 3
    Block_12_West_Sensor 'TrainBrain 2, Port 4
CONTROLS:
    Block_07_Control_3 'Dash-8 1, port 1
    Block_11_Control_3 'Dash-8 1, port 2
    Block_04_Control_3 'Dash-8 1, port 3
    Block_12_Control_3 'Dash-8 1, port 4
    Block_D1_Control_3 'Dash-8 1, port 5
    Block_D2_Control_3 'Dash-8 1, port 6
    Block_D3_Control_3 'Dash-8 1, port 7
    Block_D4_Control_3 'Dash-8 1, port 8

{--
 -  Atlas Control, Board 2

 -  Switchman 1 (16 control)
 -}
CONTROLS:
    Turnout_E1_Control 'Switchman 1, port 1
    Turnout_E2_Control 'Switchman 1, port 2
    Turnout_E3_Control 'Switchman 1, port 3
    Turnout_E4_Control 'Switchman 1, port 4
    Turnout_E5_Control 'Switchman 1, port 5
    Turnout_E6_Control 'Switchman 1, port 6
    Turnout_E7_Control 'Switchman 1, port 7
    Turnout_E8_Control 'Switchman 1, port 8
    Turnout_E9_Control 'Switchman 1, port 9
    Turnout_EA_Control 'Switchman 1, port 10
    Turnout_EB_Control 'Switchman 1, port 11
    Turnout_EC_Control 'Switchman 1, port 12
    Turnout_ED_Control 'Switchman 1, port 13
    Turnout_EE_Control 'Switchman 1, port 14
    Turnout_EF_Control 'Switchman 1, port 15
    Turnout_EG_Control 'Switchman 1, port 16

{--
 -  Tortoise, Board 2

 -  YardMaster 1 (16 control)
 -  Sentry 1 (16 sensor)
 -}
CONTROLS:
    Turnout_FX_Control 'YardMaster 1, Port 01
    Turnout_02_Control 'YardMaster 1, Port 02
    Turnout_01_Control 'YardMaster 1, Port 03
    Turnout_04_Control 'YardMaster 1, Port 04
    Turnout_09_Control 'YardMaster 1, Port 05
    Turnout_10_Control 'YardMaster 1, Port 06
    Turnout_17_Control 'YardMaster 1, Port 07
    Turnout_16_Control 'YardMaster 1, Port 08
    Turnout_03_Control 'YardMaster 1, Port 09
    Turnout_18_Control 'YardMaster 1, Port 10
    Turnout_15_Control 'YardMaster 1, Port 11
    Turnout_F0_Control 'YardMaster 1, Port 12
    Turnout_F1_Control 'YardMaster 1, Port 13
    Turnout_F2_Control 'YardMaster 1, Port 14
    Turnout_F3_Control 'YardMaster 1, Port 15
    Turnout_F4_Control 'YardMaster 1, Port 16
SENSORS:
    Turnout_FX_Sensor 'Sentry 1, Port 01
    Turnout_02_Button_Sensor 'Sentry 1, Port 02
    Turnout_01_Button_Sensor 'Sentry 1, Port 03
    Turnout_04_Button_Sensor 'Sentry 1, Port 04
    Turnout_09_Sensor 'Sentry 1, Port 05
    Turnout_10_Sensor 'Sentry 1, Port 06
    Turnout_17_Sensor 'Sentry 1, Port 07
    Turnout_16_Sensor 'Sentry 1, Port 08
    Turnout_03_Button_Sensor 'Sentry 1, Port 09
    Turnout_18_Sensor 'Sentry 1, Port 10
    Turnout_15_Sensor 'Sentry 1, Port 11
    Turnout_F0_Sensor 'Sentry 1, Port 12
    Turnout_F1_Sensor 'Sentry 1, Port 13
    Turnout_F2_Sensor 'Sentry 1, Port 14
    Turnout_F3_Sensor 'Sentry 1, Port 15
    Turnout_F4_Sensor 'Sentry 1, Port 16

{--
 -  Block Control, Board 3

 -  TrainBrain 1 (4 control, 4 sensor)
 -  TrainBrain 2 (4 control, 4 sensor)
 -  Dash-8 1 (8 control)
 -}
CONTROLS:
    Block_02_Control_1 'TrainBrain 1, Port 1
    Block_06_Control_1 'TrainBrain 1, Port 2
    Block_10_Control_1 'TrainBrain 1, Port 3
    Block_03_Control_1 'TrainBrain 1, Port 4
SENSORS:
    Block_02_East_Sensor 'TrainBrain 1, Port 1
    Block_02_West_Sensor 'TrainBrain 1, Port 2
    Block_06_East_Sensor 'TrainBrain 1, Port 3
    Block_06_West_Sensor 'TrainBrain 1, Port 4
CONTROLS:
    Block_02_Control_2 'TrainBrain 2, Port 1
    Block_06_Control_2 'TrainBrain 2, Port 2
    Block_10_Control_2 'TrainBrain 2, Port 3
    Block_03_Control_2 'TrainBrain 2, Port 4
SENSORS:
    Block_10_East_Sensor 'TrainBrain 2, Port 1
    Block_10_West_Sensor 'TrainBrain 2, Port 2
    Block_03_East_Sensor 'TrainBrain 2, Port 3
    Block_03_West_Sensor 'TrainBrain 2, Port 4
CONTROLS:
    Block_02_Control_3 'Dash-8 1, port 1
    Block_06_Control_3 'Dash-8 1, port 2
    Block_10_Control_3 'Dash-8 1, port 3
    Block_03_Control_3 'Dash-8 1, port 4
    Block_G1_Control_3 'Dash-8 1, port 5
    Block_G2_Control_3 'Dash-8 1, port 6
    Block_G3_Control_3 'Dash-8 1, port 7
    Block_G4_Control_3 'Dash-8 1, port 8

VARIABLES:
    PANEL_1_TURNOUTS[NUM_TURNOUTS]
    TURNOUT_TYPES[NUM_TURNOUTS]
    TURNOUT_STATUSES[NUM_TURNOUTS]


    TURNOUT_CONTROLS[NUM_TURNOUTS]
    ATLAS_PRIMARY_CONTROLS[NUM_TURNOUTS]
    ATLAS_SECONDARY_CONTROLS[NUM_TURNOUTS]

ACTIONS:

SUB Redraw_Turnout(TurnoutIndex)
    $SWITCH(PANEL_1_TURNOUTS[TurnoutIndex]) = $SWITCH(PANEL_1_TURNOUTS[TurnoutIndex]) ~
ENDSUB

SUB ResetInit_Set_Turnout_Types()
    TURNOUT_TYPES[0] = TURNOUT_TYPE_TORTOISE
    TURNOUT_TYPES[1] = TURNOUT_TYPE_TORTOISE
    TURNOUT_TYPES[2] = TURNOUT_TYPE_TORTOISE
    TURNOUT_TYPES[3] = TURNOUT_TYPE_TORTOISE
ENDSUB

SUB ResetInit_Set_Turnout_Controls()
    TURNOUT_CONTROLS[0] = &Turnout_01_Control
    TURNOUT_CONTROLS[1] = &Turnout_02_Control
    TURNOUT_CONTROLS[2] = &Turnout_03_Control
    TURNOUT_CONTROLS[3] = &Turnout_04_Control
ENDSUB

SUB ResetInit_Set_Turnouts_On_Panels()
    PANEL_1_TURNOUTS[0] = (27,28,1)
    PANEL_1_TURNOUTS[1] = (30,29,1)
    PANEL_1_TURNOUTS[2] = (43,32,1)
    PANEL_1_TURNOUTS[3] = (36,28,1)
ENDSUB

SUB Set_Turnout(TurnoutIndex, Direction)
    ' Invert status of turnout, from thrown to straight or vice versa
    TURNOUT_STATUSES[TurnoutIndex] = TURNOUT_STATUSES[TurnoutIndex] ~

    ' Set the control to the new state (led + turnout for tortoise, led only for atlas)
    *TURNOUT_CONTROLS[TurnoutIndex] = TURNOUT_STATUSES[TurnoutIndex]

    ' Handle that atlas can only take a quick pulse
    IF TURNOUT_TYPES[TurnoutIndex] = TURNOUT_TYPE_ATLAS THEN
        IF TURNOUT_STATUSES[TurnoutIndex] = TURNOUT_DIRECTION_PRIMARY THEN
            *ATLAS_SECONDARY_CONTROLS[TurnoutIndex] = PULSE 0.25
        ELSE
            *ATLAS_PRIMARY_CONTROLS[TurnoutIndex] = PULSE 0.25
        ENDIF
    ENDIF

    ' Redraw turnout on panel
    Redraw_Turnout(TurnoutIndex)
ENDSUB

SUB Throw_Turnout(TurnoutIndex)
    Set_Turnout(TurnoutIndex, TURNOUT_STATUSES[TurnoutIndex] ~)
ENDSUB

SUB ResetInit_Set_Turnouts_To_Primary({local} TurnoutIndex)
    TurnoutIndex = 0
    UNTIL TurnoutIndex >= NUM_TURNOUTS QUICKLOOP
        Set_Turnout(TurnoutIndex, TURNOUT_DIRECTION_PRIMARY)

        TurnoutIndex = 1 +
    ENDLOOP
ENDSUB




{--
 - When starting up (hitting train icon) or hitting reset button
 -}
WHEN $RESET = TRUE DO
    ResetInit_Set_Turnout_Types()
    ResetInit_Set_Turnout_Controls()
    ResetInit_Set_Turnouts_On_Panels()
    ResetInit_Set_Turnouts_To_Primary()

{--
 - Triggers for throwing a turnout, either by panel or by physical button
 -}
    WHEN $LEFTMOUSE = PANEL_1_TURNOUTS[0] OR Turnout_01_Button_Sensor = ON DO Throw_Turnout(0)
    WHEN $LEFTMOUSE = PANEL_1_TURNOUTS[1] OR Turnout_02_Button_Sensor = ON DO Throw_Turnout(1)
    WHEN $LEFTMOUSE = PANEL_1_TURNOUTS[2] OR Turnout_03_Button_Sensor = ON DO Throw_Turnout(2)
    WHEN $LEFTMOUSE = PANEL_1_TURNOUTS[3] OR Turnout_04_Button_Sensor = ON DO Throw_Turnout(3)

